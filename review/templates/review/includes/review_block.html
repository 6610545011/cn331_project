{% comment %}
    This template expects a 'review' object in the context.
{% endcomment %}
<div class="info-card review-card">
    <div class="review-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
        <h4>{{ review.head }}</h4>
        {% if user.is_authenticated %}
        <div class="btn-group">
            <button class="btn btn-sm bookmark-btn {% if review.is_bookmarked %}btn-primary{% else %}btn-outline-primary{% endif %}" 
                    data-review-id="{{ review.id }}" 
                    data-url="{% url 'review:toggle_bookmark' review.id %}">
                {% if review.is_bookmarked %}
                <i class="fas fa-bookmark"></i> Bookmarked
                {% else %}
                <i class="far fa-bookmark"></i> Bookmark
                {% endif %}
            </button>
            <button class="btn btn-sm btn-outline-danger report-btn" data-bs-toggle="modal" data-bs-target="#reportModal-{{ review.id }}">
                <i class="fas fa-flag"></i> Report
            </button>
        </div>
        {% endif %}
    </div>
    <p class="review-rating"><strong>Rating:</strong> {{ review.rating }}/5</p>
    <p>{{ review.body }}</p>
    <div class="review-meta">
        <span class="review-author">
            By
            {% if review.incognito %}
            Anonymous
            {% else %}
            {{ review.user.get_full_name|default:review.user.username }}
            {% endif %}
            on {{ review.date_created|date:"M d, Y" }}
        </span>

        {% if user.is_authenticated %}
        <div class="review-actions">
            <form class="vote-form d-inline-block" data-url="{% url 'review:vote_review' review.id %}" method="post">
                {% csrf_token %}
                <button type="submit" name="vote_type" value="1" class="btn btn-sm vote-btn upvote-btn {% if review.user_vote == 1 %}btn-success{% else %}btn-outline-success{% endif %}">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <span class="vote-score" data-review-id="{{ review.id }}">{{ review.vote_score|default:0 }}</span>
                <button type="submit" name="vote_type" value="-1" class="btn btn-sm vote-btn downvote-btn {% if review.user_vote == -1 %}btn-danger{% else %}btn-outline-danger{% endif %}">
                    <i class="fas fa-arrow-down"></i>
                </button>
            </form>
        </div>
        {% endif %}
    </div>
</div>
{% if user.is_authenticated %}
<!-- Report Modal -->
<div class="modal fade" id="reportModal-{{ review.id }}" tabindex="-1" aria-labelledby="reportModalLabel-{{ review.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportModalLabel-{{ review.id }}">Report Review TODO make it a popup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="reportForm-{{ review.id }}" class="report-form" data-url="{% url 'review:report_review' review.id %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div id="report-alert-{{ review.id }}"></div>
                    <p>You are reporting the review for: <strong>{{ review.head }}</strong></p>
                    <div class="mb-3">
                        <label for="id_comment_{{ review.id }}" class="form-label">Reason for reporting:</label>
                        <textarea name="comment" class="form-control" id="id_comment_{{ review.id }}" rows="4" placeholder="Please provide a reason for reporting this review..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Report</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Use event delegation for clicks
    document.body.addEventListener('click', function(e) {
        const bookmarkBtn = e.target.closest('.bookmark-btn');
        if (bookmarkBtn) {
            e.preventDefault();
            const url = bookmarkBtn.dataset.url;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}', // Make sure csrf_token is available
                    'Content-Type': 'application/json'
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    bookmarkBtn.classList.toggle('btn-primary', data.bookmarked);
                    bookmarkBtn.classList.toggle('btn-outline-primary', !data.bookmarked);
                    bookmarkBtn.innerHTML = data.bookmarked ? '<i class="fas fa-bookmark"></i> Bookmarked' : '<i class="far fa-bookmark"></i> Bookmark';
                }
            })
            .catch(error => console.error('Error toggling bookmark:', error));
        }
    });

    // Use event delegation for form submissions
    document.body.addEventListener('submit', function(e) {
        const reportForm = e.target.closest('.report-form');
        if (reportForm) {
            e.preventDefault();
            const reviewId = reportForm.id.split('-')[1];
            const formData = new FormData(reportForm);
            const url = reportForm.dataset.url;
            const alertContainer = document.getElementById(`report-alert-${reviewId}`);

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                },
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                let alertClass = 'alert-danger';
                let message = 'An unknown error occurred.';

                if (status === 200 && body.status === 'ok') {
                    alertClass = 'alert-success';
                    message = body.message;
                    reportForm.reset();
                    // Hide the modal after a short delay
                    setTimeout(() => {
                        const modalEl = document.getElementById(`reportModal-${reviewId}`);
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        if (modal) {
                            modal.hide();
                        }
                        alertContainer.innerHTML = ''; // Clear alert on successful close
                    }, 2500);
                } else {
                    message = body.message || 'Please correct the errors below.';
                }
                alertContainer.innerHTML = `<div class="alert ${alertClass}" role="alert">${message}</div>`;
            })
            .catch(error => {
                console.error('Error:', error);
                alertContainer.innerHTML = `<div class="alert alert-danger" role="alert">A network error occurred. Please try again.</div>`;
            });
        }
    });

    // Use event delegation for vote form submissions
    document.body.addEventListener('submit', function(e) {
        const voteForm = e.target.closest('.vote-form');
        if (voteForm) {
            e.preventDefault();
            const reviewId = voteForm.dataset.url.split('/')[3]; // A bit brittle, but works for the URL structure
            const voteType = e.submitter.value;
            const url = voteForm.dataset.url;

            // Disable buttons to prevent spamming
            const upvoteBtn = voteForm.querySelector('.upvote-btn');
            const downvoteBtn = voteForm.querySelector('.downvote-btn');
            upvoteBtn.disabled = true;
            downvoteBtn.disabled = true;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 'vote_type': voteType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    // Update vote score
                    const scoreSpan = document.querySelector(`.vote-score[data-review-id="${reviewId}"]`);
                    scoreSpan.textContent = data.new_score;

                    // Update button states
                    upvoteBtn.classList.toggle('btn-success', data.user_vote == 1);
                    upvoteBtn.classList.toggle('btn-outline-success', data.user_vote != 1);
                    downvoteBtn.classList.toggle('btn-danger', data.user_vote == -1);
                    downvoteBtn.classList.toggle('btn-outline-danger', data.user_vote != -1);
                }
            })
            .catch(error => console.error('Error submitting vote:', error))
            .finally(() => {
                // Re-enable buttons after the request is complete
                upvoteBtn.disabled = false;
                downvoteBtn.disabled = false;
            });
        }
    });
});
</script>