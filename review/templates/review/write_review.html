{% extends "core/template.html" %}
{% load static %}

{% block title %}Write Review - Thammasat Study Plan{% endblock title %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'review/css/review_form.css' %}">
{% endblock extra_head %}

{% block content %}
<main class="content-area">
    <div class="review-form-container">
        <h1>เขียนรีวิวรายวิชา</h1>
        
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <form method="post" novalidate>
            {% csrf_token %}
            
            <div class="form-group">
                {{ form.course.label_tag }}
                {{ form.course }}
                {% if form.course.errors %}<div class="errors">{{ form.course.errors }}</div>{% endif %}
            </div>

            <!-- --- แก้ไขตรงนี้: เปลี่ยนจาก section_number เป็น section --- -->
            <div class="form-group">
                {{ form.section.label_tag }}
                {{ form.section }}
                {% if form.section.errors %}<div class="errors">{{ form.section.errors }}</div>{% endif %}
            </div>

            <div class="form-group">
                {{ form.professor.label_tag }}
                {{ form.professor }}
                {% if form.professor.errors %}<div class="errors">{{ form.professor.errors }}</div>{% endif %}
            </div>

            <!-- ... ส่วนที่เหลือของฟอร์มเหมือนเดิม ... -->
            <div class="form-group rating-group">
                {{ form.rating.label_tag }}
                <div class="star-rating">
                    {% for radio in form.rating reversed %}
                        {{ radio.tag }}
                        <label for="{{ radio.id_for_label }}" class="star-label" title="{{ radio.choice_label }} ดาว"><i class="fas fa-star"></i></label>
                    {% endfor %}
                </div>
                {% if form.rating.errors %}<div class="errors">{{ form.rating.errors }}</div>{% endif %}
            </div>

            <div class="form-group">
                {{ form.header.label_tag }}
                {{ form.header }}
                {% if form.header.errors %}<div class="errors">{{ form.header.errors }}</div>{% endif %}
            </div>

            <div class="form-group">
                {{ form.body.label_tag }}
                {{ form.body }}
                {% if form.body.errors %}<div class="errors">{{ form.body.errors }}</div>{% endif %}
            </div>

            <div class="form-group incognito-group">
                {{ form.incognito }}
                {{ form.incognito.label_tag }}
                {% if form.incognito.errors %}<div class="errors">{{ form.incognito.errors }}</div>{% endif %}
            </div>

            <button type="submit" class="btn-submit">ส่งรีวิว</button>
        </form>
    </div>
</main>
{% endblock content %}

<!-- ส่วน HTML ของ template ไม่ต้องแก้ไข ใช้โค้ดเดิมได้เลย -->

{% block extra_scripts %}
<script>
$(document).ready(function() {
    // --- ส่วน Select2 ของ Course (เหมือนเดิม) ---
    $('#id_course').select2({
        placeholder: 'พิมพ์รหัสวิชาหรือชื่อวิชาเพื่อค้นหา',
        allowClear: true,
        ajax: {
            url: "{% url 'review:ajax_search_courses' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) { return { term: params.term }; },
            processResults: function (data) { return { results: data.results }; },
            cache: true
        }
    });

    // --- อ้างอิง element และตั้งค่าเริ่มต้น ---
    const courseSelect = $('#id_course');
    const sectionSelect = $('#id_section');
    const professorSelect = $('#id_professor');

    // ทำให้ Section และ Professor เป็น Select2 และปิดการใช้งานไว้ก่อน
    sectionSelect.select2({ placeholder: '--- กรุณาเลือกรายวิชาก่อน ---' }).prop('disabled', true);
    professorSelect.select2({ placeholder: '--- กรุณาเลือก Section ก่อน ---', allowClear: true }).prop('disabled', true);

    // --- Event 1: เมื่อมีการเลือก "รายวิชา" ---
    courseSelect.on('select2:select', function (e) {
        const courseId = e.params.data.id;

        // 1. โหลด Sections (เหมือนเดิม)
        sectionSelect.prop('disabled', false).html('<option>กำลังโหลด...</option>');
        $.ajax({
            url: "{% url 'review:ajax_get_sections' %}",
            data: { 'course_id': courseId },
            success: function (data) {
                sectionSelect.empty().append('<option value="">--- เลือก Section ---</option>');
                if (data.sections.length > 0) {
                    data.sections.forEach(function(sec) {
                        sectionSelect.append(new Option(sec.text, sec.id));
                    });
                } else {
                    sectionSelect.append('<option value="">ไม่พบข้อมูล Section</option>');
                }
            }
        });

        // 2. (สำคัญ) Reset ช่องอาจารย์ และปิดการใช้งานไว้ก่อน
        professorSelect.empty().append('<option value="">--- กรุณาเลือก Section ก่อน ---</option>').prop('disabled', true);
    });

    // --- Event 2: เมื่อล้างการเลือก "รายวิชา" ---
    courseSelect.on('select2:unselect', function (e) {
        // Reset และปิดการใช้งานทั้ง Section และ Professor
        sectionSelect.empty().append('<option value="">--- กรุณาเลือกรายวิชาก่อน ---</option>').prop('disabled', true);
        professorSelect.empty().append('<option value="">--- กรุณาเลือก Section ก่อน ---</option>').prop('disabled', true);
    });

    // --- Event 3 (ใหม่): เมื่อมีการเลือก "Section" ---
    sectionSelect.on('select2:select', function (e) {
        const sectionId = e.params.data.id;

        // ถ้าไม่มีการเลือก section (เลือกค่าว่าง) ให้ reset ช่องอาจารย์
        if (!sectionId) {
            professorSelect.empty().append('<option value="">--- กรุณาเลือก Section ก่อน ---</option>').prop('disabled', true);
            return;
        }

        // โหลดรายชื่ออาจารย์สำหรับ Section ที่เลือก
        professorSelect.prop('disabled', false).html('<option>กำลังโหลด...</option>');
        $.ajax({
            url: "{% url 'review:ajax_get_professors' %}",
            data: { 'section_id': sectionId }, // ส่ง section_id ไปแทน
            success: function (data) {
                professorSelect.empty().append('<option value="">--- เลือกอาจารย์ผู้สอน (ถ้ามี) ---</option>');
                if (data.professors.length > 0) {
                    data.professors.forEach(function(prof) {
                        professorSelect.append(new Option(prof.name, prof.id));
                    });
                } else {
                    professorSelect.append('<option value="">ไม่พบข้อมูลอาจารย์</option>');
                }
            }
        });
    });

    // --- Event 4 (ใหม่): เมื่อล้างการเลือก "Section" ---
    sectionSelect.on('select2:unselect', function (e) {
        // Reset และปิดการใช้งานช่อง Professor
        professorSelect.empty().append('<option value="">--- กรุณาเลือก Section ก่อน ---</option>').prop('disabled', true);
    });

});
</script>
{% endblock extra_scripts %}