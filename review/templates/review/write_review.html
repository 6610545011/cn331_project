{% extends "core/template.html" %}
{% load static %}

{% block title %}Write Review - Thammasat Study Plan{% endblock title %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'review/css/review_form.css' %}">
{% endblock extra_head %}

{% block content %}
<main class="content-area">
    <div class="review-form-container">
        <h1>WRITE REVIEW</h1>
        
        {# General error messages (e.g., missing required selections) #}
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <form method="post" novalidate>
            {% csrf_token %}
            
            <div class="form-group">
                {{ form.course.label_tag }}
                {{ form.course }}
                {% if form.course.errors %}<div class="errors">{{ form.course.errors }}</div>{% endif %}
            </div>

            <div class="form-group">
                {{ form.section.label_tag }}
                {{ form.section }}
                {% if form.section.errors %}<div class="errors">{{ form.section.errors }}</div>{% endif %}
            </div>

            <div class="form-group">
                {{ form.prof.label_tag }}
                {{ form.prof }}
                {% if form.prof.errors %}<div class="errors">{{ form.prof.errors }}</div>{% endif %}
            </div>

            <hr style="margin: 30px 0; border-top: 1px solid #eee;">

            <div class="form-group">
                {{ form.header.label_tag }}
                {{ form.header }}
                {% if form.header.errors %}<div class="errors">{{ form.header.errors }}</div>{% endif %}
            </div>

            <div class="form-group">
                {{ form.body.label_tag }}
                {{ form.body }}
                {% if form.body.errors %}<div class="errors">{{ form.body.errors }}</div>{% endif %}
            </div>

            <div class="form-group rating-group">
                {{ form.rating.label_tag }}
                <div class="star-rating">
                    {% for radio in form.rating %}
                        {{ radio.tag }}
                        <label for="{{ radio.id_for_label }}" class="star-label" title="{{ radio.choice_label }} stars"><i class="fas fa-star"></i></label>
                    {% endfor %}
                </div>
                {% if form.rating.errors %}<div class="errors">{{ form.rating.errors }}</div>{% endif %}
            </div>

            <div class="form-group incognito-group">
                {{ form.incognito }}
                {{ form.incognito.label_tag }}
                {% if form.incognito.errors %}<div class="errors">{{ form.incognito.errors }}</div>{% endif %}
            </div>

            <div class="form-group tag-group">
                {{ form.tags.label_tag }}
                <div class="tag-checkboxes">
                    {{ form.tags }}
                </div>
                {% if form.tags.errors %}<div class="errors">{{ form.tags.errors }}</div>{% endif %}
            </div>

            <button type="submit" class="btn-submit">Post Review</button>
        </form>
    </div>
</main>
{% endblock content %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    const courseSelect = $('#id_course');
    const sectionSelect = $('#id_section');
    const professorSelect = $('#id_professor');

    // ทำให้ Dropdown สวยงามด้วย Select2
    courseSelect.select2({ placeholder: '--- Select a course review (optional). ---', allowClear: true });
    professorSelect.select2({ placeholder: '--- Choose a professor review (optional). ---', allowClear: true });
    sectionSelect.select2({ placeholder: '--- Please select a course first ---' });

    // Event: เมื่อมีการเลือกหรือล้างการเลือกรายวิชา
    courseSelect.on('change', function() {
        const courseId = $(this).val();

        if (courseId) {
            // ถ้ามี courseId, ให้ไปโหลด Section
            sectionSelect.prop('disabled', false).html('<option>loading...</option>');
            $.ajax({
                url: "{% url 'review:ajax_get_sections' %}",
                data: { 'course_id': courseId },
                success: function (data) {
                    sectionSelect.empty().append('<option value="">--- Select Section (optional) ---</option>');
                    if (data.sections.length > 0) {
                        data.sections.forEach(function(sec) {
                            sectionSelect.append(new Option(sec.text, sec.id));
                        });
                    } else {
                        sectionSelect.append('<option value="">No sections found that you have registered for</option>');
                    }
                    sectionSelect.trigger('change'); // Update Select2
                }
            });
        } else {
            // If no courseId (selection cleared), reset and disable Section dropdown
            sectionSelect.empty().append('<option value="">--- Please select a course first ---</option>').prop('disabled', true).trigger('change');
        }
    });
});
</script>
{% endblock extra_scripts %}