{% extends "core/template.html" %}
{% load static %}

{% block title %}Write Review - Thammasat Study Plan{% endblock title %}

{% block extra_head %}
{# ลิงก์ไปยังไฟล์ CSS ภายนอกสำหรับหน้านี้โดยเฉพาะ #}
<link rel="stylesheet" href="{% static 'review/css/review_form.css' %}">
{% endblock extra_head %}

{% block content %}
<main class="content-area">
    <div class="review-form-container">
        <h1>เขียนรีวิวรายวิชา</h1>
        <form method="post" novalidate>
            {% csrf_token %}
            
            <div class="form-group">
                {{ form.course.label_tag }}
                {{ form.course }}
                {% if form.course.errors %}<div class="errors">{{ form.course.errors }}</div>{% endif %}
            </div>

            <div class="form-group">
                {{ form.professor.label_tag }}
                {{ form.professor }}
                {% if form.professor.errors %}<div class="errors">{{ form.professor.errors }}</div>{% endif %}
            </div>

            <div class="form-group">
                {{ form.rating.label_tag }}
                <ul class="rating-choices">
                    {% for radio in form.rating %}
                    <li>
                        {{ radio.tag }}
                        <label for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                    </li>
                    {% endfor %}
                </ul>
                {% if form.rating.errors %}<div class="errors">{{ form.rating.errors }}</div>{% endif %}
            </div>

            <div class="form-group">
                {{ form.header.label_tag }}
                {{ form.header }}
                {% if form.header.errors %}<div class="errors">{{ form.header.errors }}</div>{% endif %}
            </div>

            <div class="form-group">
                {{ form.body.label_tag }}
                {{ form.body }}
                {% if form.body.errors %}<div class="errors">{{ form.body.errors }}</div>{% endif %}
            </div>

            <div class="form-group incognito-group">
                {{ form.incognito }}
                {{ form.incognito.label_tag }}
                {% if form.incognito.errors %}<div class="errors">{{ form.incognito.errors }}</div>{% endif %}
            </div>

            <button type="submit" class="btn-submit">ส่งรีวิว</button>
        </form>
    </div>
</main>
{% endblock content %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    // --- ส่วนที่ 1: ทำให้ช่อง "รายวิชา" ค้นหาได้ด้วย Select2 ---
    $('#id_course').select2({
        placeholder: 'พิมพ์รหัสวิชาหรือชื่อวิชาเพื่อค้นหา',
        allowClear: true,
        ajax: {
            url: "{% url 'review:ajax_search_courses' %}",
            dataType: 'json',
            delay: 250, // รอ 250ms หลังพิมพ์เสร็จถึงจะค้นหา
            data: function (params) {
                return {
                    term: params.term // ส่งคำค้นหา (term) ไปที่ view
                };
            },
            processResults: function (data) {
                // แปลงข้อมูลที่ได้จาก API ให้อยู่ในรูปแบบที่ Select2 เข้าใจ
                return {
                    results: data.results
                };
            },
            cache: true
        }
    });

    // --- ส่วนที่ 2: ควบคุมช่อง "อาจารย์ผู้สอน" ให้ขึ้นอยู่กับ "รายวิชา" ---
    const courseSelect = $('#id_course');
    const professorSelect = $('#id_professor');

    // เริ่มต้นให้ช่องอาจารย์เป็น disabled (ปิดการใช้งาน)
    professorSelect.prop('disabled', true);

    // Event: เมื่อมีการเลือกรายวิชา
    courseSelect.on('select2:select', function (e) {
        const courseId = e.params.data.id;

        // เปิดใช้งานช่องอาจารย์และแสดงสถานะกำลังโหลด
        professorSelect.prop('disabled', false).html('<option>กำลังโหลด...</option>');

        // เรียก API เพื่อดึงรายชื่ออาจารย์สำหรับวิชาที่เลือก
        $.ajax({
            url: "{% url 'review:ajax_get_professors' %}",
            data: {
                'course_id': courseId
            },
            success: function (data) {
                professorSelect.empty().append('<option value="">--- เลือกอาจารย์ผู้สอน ---</option>');
                if (data.professors.length > 0) {
                    data.professors.forEach(function(prof) {
                        professorSelect.append(new Option(prof.name, prof.id));
                    });
                } else {
                    professorSelect.append('<option value="">ไม่พบข้อมูลอาจารย์สำหรับวิชานี้</option>');
                }
            },
            error: function() {
                professorSelect.html('<option value="">เกิดข้อผิดพลาดในการโหลดข้อมูล</option>');
            }
        });
    });

    // Event: เมื่อล้างการเลือกรายวิชา (กด x)
    courseSelect.on('select2:unselect', function (e) {
        // ล้างข้อมูล, ปิดการใช้งาน, และตั้งค่าข้อความเริ่มต้น
        professorSelect.empty().append('<option value="">--- กรุณาเลือกรายวิชาก่อน ---</option>').prop('disabled', true);
    });
});
</script>
{% endblock extra_scripts %}