{% extends "core/template.html" %}
{% load static %}
{% load core_extras %}

{% block title %}Search Results for "{{ query }}" - Thammasat Study Plan{% endblock title %}

{% block extra_head %}
{# ลิงก์ไปยัง CSS ใหม่ที่เราสร้างขึ้น #}
<link rel="stylesheet" href="{% static 'core/css/search_page.css' %}">
{% endblock extra_head %}

{% block content %}
<div class="search-page-container">
    <h1>Search Results</h1>

    {# --- Search Bar --- #}
    <form method="get" action="{% url 'core:search' %}" class="search-form">
        <input type="text" name="q" placeholder="Search for courses, professors..." value="{{ query }}">
        <button type="submit">Search</button>
    </form>

    {% if results %}
        {# --- Tab Navigation --- #}
        <div class="search-tabs">
            <a class="tab-link active" data-target="#all-results">All ({{ results|length }})</a>
            {% if professors %}<a class="tab-link" data-target="#professors-results">Professors ({{ professors.count }})</a>{% endif %}
            {% if courses %}<a class="tab-link" data-target="#courses-results">Courses ({{ courses.count }})</a>{% endif %}
            {% if sections %}<a class="tab-link" data-target="#sections-results">Sections ({{ sections.count }})</a>{% endif %}
        </div>

        {# --- Tab Content --- #}
        <div class="tab-content">
            
            {# Panel for "All" results #}
            <div id="all-results" class="tab-panel active">
                {% if professors %}
                <div class="result-category">
                    <h3>Professors</h3>
                    <ul class="result-list">
                        {% for prof in professors %}
                            <li class="result-item">
                                <h4><a href="{% url 'core:professor_detail' pk=prof.pk %}">{{ prof.prof_name }}</a></h4>
                                <p>{{ prof.description|default:"No description available."|truncatewords:30 }}</p>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if courses %}
                <div class="result-category">
                    <h3>Courses</h3>
                    <ul class="result-list">
                        {% for course in courses %}
                            <li class="result-item">
                                <h4><a href="{% url 'core:course_detail' pk=course.pk %}">{{ course.course_name }} ({{ course.course_code }})</a></h4>
                                <p>{{ course.description|default:"No description available."|truncatewords:30 }}</p>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if sections %}
                <div class="result-category">
                    <h3>Sections</h3>
                    <ul class="result-list">
                        {% for section in sections %}
                            <li class="result-item">
                                <h4><a href="{% url 'core:course_detail' pk=section.course.pk %}">{{ section.course.course_code }} - {{ section.course.course_name }} (Section: {{ section.section_number }})</a></h4>
                                <p>Taught by: 
                                    {% for teacher in section.teachers.all %}<a href="{% url 'core:professor_detail' pk=teacher.pk %}">{{ teacher.prof_name }}</a>{% if not forloop.last %}, {% endif %}{% empty %}N/A{% endfor %}
                                </p>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>

            {# Panel for "Professors" #}
            {% if professors %}
            <div id="professors-results" class="tab-panel">
                <ul class="result-list">
                    {% for prof in professors %}
                        <li class="result-item">
                            <h4><a href="{% url 'core:professor_detail' pk=prof.pk %}">{{ prof.prof_name }}</a></h4>
                            <p>{{ prof.description|default:"No description available."|truncatewords:30 }}</p>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {# Panel for "Courses" #}
            {% if courses %}
            <div id="courses-results" class="tab-panel">
                <ul class="result-list">
                    {% for course in courses %}
                        <li class="result-item">
                            <h4><a href="{% url 'core:course_detail' pk=course.pk %}">{{ course.course_name }} ({{ course.course_code }})</a></h4>
                            <p>{{ course.description|default:"No description available."|truncatewords:30 }}</p>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {# Panel for "Sections" #}
            {% if sections %}
            <div id="sections-results" class="tab-panel">
                <ul class="result-list">
                    {% for section in sections %}
                        <li class="result-item">
                            <h4>
                                <a href="{% url 'core:course_detail' pk=section.course.pk %}">{{ section.course.course_code }} - {{ section.course.course_name }} (Section: {{ section.section_number }})</a>
                            </h4>
                            <p>Taught by: 
                                {% for teacher in section.teachers.all %}
                                    <a href="{% url 'core:professor_detail' pk=teacher.pk %}">{{ teacher.prof_name }}</a>{% if not forloop.last %}, {% endif %}
                                {% empty %}
                                    N/A
                                {% endfor %}
                            </p>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>

    {% else %}
        {# --- "No Results" Message --- #}
        <div class="no-results" style="text-align: center; padding: 2rem;">
            <p>No results found for "<strong>{{ query }}</strong>".</p>
            <p>Please try a different search term.</p>
        </div>
    {% endif %}
</div>
{% endblock content %}

{% block extra_scripts %}
{# --- JavaScript for Tab functionality --- #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.tab-link');
    const panels = document.querySelectorAll('.tab-panel');

    tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();

            // Remove active class from all tabs and panels
            tabs.forEach(item => item.classList.remove('active'));
            panels.forEach(panel => panel.classList.remove('active'));

            // Add active class to the clicked tab and its corresponding panel
            const targetId = this.getAttribute('data-target');
            const targetPanel = document.querySelector(targetId);
            
            this.classList.add('active');
            if (targetPanel) {
                targetPanel.classList.add('active');
            }
        });
    });
});
</script>
{% endblock extra_scripts %}