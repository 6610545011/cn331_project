{% extends "core/template.html" %}
{% load static %}
{% load core_extras %}

{% block title %}Search Results for "{{ query }}" - Thammasat Study Plan{% endblock title %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'core/css/search_page.css' %}">
{% endblock extra_head %}

{% block content %}
<div class="search-page-container">
    <h1>Search Results</h1>

    <form method="get" action="{% url 'core:search' %}" class="search-form">
        <input type="text" name="q" placeholder="Search for courses, professors..." value="{{ query }}">
        <button type="submit"><i class="fas fa-search"></i></button>
    </form>

    {% if results %}
        <div class="search-tabs">
            {% if professors %}<a class="tab-link active" data-target="#professors-results">Professors ({{ professors.count }})</a>{% endif %}
            {% if courses %}<a class="tab-link {% if not professors %}active{% endif %}" data-target="#courses-results">Courses ({{ courses.count }})</a>{% endif %}
            {% if sections %}<a class="tab-link {% if not professors and not courses %}active{% endif %}" data-target="#sections-results">Sections ({{ sections.count }})</a>{% endif %}
            {% if reviews %}<a class="tab-link {% if not professors and not courses and not sections %}active{% endif %}" data-target="#reviews-results">Reviews ({{ reviews.count }})</a>{% endif %}
        </div>

        <div class="tab-content">
            {% if professors %}
            <div id="professors-results" class="tab-panel active">
                <ul class="result-list">
                    {% for prof in professors %}
                        <li class="result-item">
                            <h4><a href="{% url 'core:professor_detail' pk=prof.pk %}">{{ prof.prof_name }}</a></h4>
                            <p>{{ prof.description|default:"No description available."|truncatewords:30 }}</p>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if courses %}
            <div id="courses-results" class="tab-panel {% if not professors %}active{% endif %}">
                <ul class="result-list">
                    {% for course in courses %}
                        <li class="result-item">
                            <h4><a href="{% url 'core:course_detail' pk=course.pk %}">{{ course.course_name }} ({{ course.course_code }})</a></h4>
                            <p>{{ course.description|default:"No description available."|truncatewords:30 }}</p>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if sections %}
            <div id="sections-results" class="tab-panel {% if not professors and not courses %}active{% endif %}">
                <ul class="result-list">
                    {% for section in sections %}
                        <li class="result-item">
                            <h4>
                                <a href="{% url 'core:course_detail' pk=section.course.pk %}">{{ section.course.course_code }} - {{ section.course.course_name }} (Section: {{ section.section_number }})</a>
                            </h4>
                            <p>Taught by: 
                                {% for teacher in section.teachers.all %}
                                    <a href="{% url 'core:professor_detail' pk=teacher.pk %}">{{ teacher.prof_name }}</a>{% if not forloop.last %}, {% endif %}
                                {% empty %}
                                    N/A
                                {% endfor %}
                            </p>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if reviews %}
            <div id="reviews-results" class="tab-panel {% if not professors and not courses and not sections %}active{% endif %}">
                <ul class="result-list card-list">
                    {% for review in reviews %}
                        {% include "review/includes/review_block.html" with review=review %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>

    {% else %}
        <div class="no-results">
            <p>No results found for "<strong>{{ query }}</strong>".</p>
            <p>Please try a different search term.</p>
        </div>
    {% endif %}
</div>
{% endblock content %}

{% block extra_scripts %}
{% include "review/includes/review_actions_js.html" %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const tabs = document.querySelectorAll('.tab-link');
    const panels = document.querySelectorAll('.tab-panel');

    tabs.forEach(tab => {
        tab.addEventListener('click', function (e) {
            e.preventDefault();

            tabs.forEach(t => t.classList.remove('active'));
            panels.forEach(p => p.classList.remove('active'));

            this.classList.add('active');
            const target = document.querySelector(this.dataset.target);
            if (target) {
                target.classList.add('active');
            }
        });
    });
});
</script>
{% endblock extra_scripts %}
