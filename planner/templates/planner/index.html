{% extends 'core/template.html' %}
{% load static %}

{% block title %}Class Schedule{% endblock %}

{% block extra_head %}
<style>
  .timetable-wrap { margin: 12px 0 28px; overflow-x: auto; }
  .timetable-grid { display: grid; grid-auto-rows: 60px; border: 1px solid #e5e7eb; }
  /* first column for day labels (fixed) + 24 slot columns */
  .timetable-grid { grid-template-columns: 140px repeat(24, 1fr); }
  .time-header { background: #f3f4f6; border-bottom: 1px solid #e5e7eb; display: contents; }
  .time-cell { padding: 8px; font-weight: 600; text-align: center; border-left: 1px solid #eaeaea; }
  .day-label { background: #f9fafb; padding: 12px; border-right: 1px solid #eaeaea; display:flex; align-items:center; justify-content:center; font-weight:700; }

  .slot-cell { border-left: 1px solid #f1f5f9; border-bottom: 1px dashed #f3f4f6; }

  .course-block {
    padding: 6px 8px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    font-size: 12px; line-height: 1.1; display: flex; flex-direction: column; justify-content: center;
    overflow: hidden;
  }

  /* container for visual layout */
  .timetable-container { min-width: 1100px; }

  /* bottom table */
  .course-table { width: 100%; border-collapse: collapse; margin-top: 18px; }
  .course-table th, .course-table td { border: 1px solid #e5e7eb; padding: 8px 10px; text-align: left; }
  .course-table th { background: #f3f4f6; }

  @media (max-width: 900px) {
    .timetable-grid { grid-template-columns: 100px repeat(24, minmax(40px, 1fr)); }
    .timetable-container { min-width: 900px; }
  }
</style>
{% endblock %}

{% block content %}
<h2>Class Schedule</h2>
<p>30-minute slots from {{ slot_start_hour }}:00 — {{ slot_start_hour|add:slot_count|default:20 }}:00</p>

<!-- Search and Browse Courses Section -->
{% if user.is_authenticated %}
<div style="margin-bottom:30px; padding:20px; border:1px solid #e5e7eb; background:#f9fafb; border-radius:8px;">
  <h3 style="margin-top:0; margin-bottom:16px;">Browse & Add Courses</h3>
  
  <!-- Search Input -->
  <div style="margin-bottom:16px;">
    <input type="text" id="course-search-input" placeholder="Search by course code or name..." style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:4px; font-size:14px;">
    <div id="search-status" style="color:#666; font-size:12px; margin-top:6px;"></div>
  </div>

  <!-- Results Display (Grid of Cards) -->
  <div id="search-results" style="display:grid; gap:12px; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr));">
  </div>
</div>
{% endif %}

<div class="timetable-wrap">
  <div class="timetable-container">
    <div class="timetable-grid">
      {# Top-left empty cell (corner) #}
      <div class="time-header time-cell" style="grid-column:1 / 2; grid-row:1 / 2;"></div>

      {# Actual header time columns (columns 2..25) - we keep labels minimal in this template #}
      {% for label in slot_labels %}
        <div class="time-cell" style="grid-column: {{ forloop.counter0|add:2 }} / {{ forloop.counter0|add:3 }}; grid-row: 1 / 2;">{{ label }}</div>
      {% endfor %}

      {# Days rows: row index starts at 2 (row 1 is header) #}
      {% for day in days_enum %}
        <div class="day-label" style="grid-column:1 / 2; grid-row: {{ day.idx|add:2 }} / {{ day.idx|add:3 }};">{{ day.name }}</div>
        {% for col in slot_indices %}
          <div class="slot-cell" style="grid-column: {{ forloop.counter0|add:2 }} / {{ forloop.counter0|add:3 }}; grid-row: {{ day.idx|add:2 }} / {{ day.idx|add:3 }};"></div>
        {% endfor %}
      {% endfor %}

      {# Course blocks positioned using CSS Grid coordinates computed in the view #}
      {% for item in items %}
        <div class="course-block" style="grid-column: {{ item.css_start_col }} / span {{ item.css_span_col }}; grid-row: {{ item.day|add:2 }} / span 1; background: {{ item.color }};">
          <strong>{{ item.course_code }} • Sec {{ item.section_number }}</strong>
          {% if item.room %}<small>{{ item.room }}</small>{% endif %}
        </div>
      {% endfor %}

    </div>
  </div>
</div>

<!-- Save current planner as named schedule and history -->
{% if user.is_authenticated %}
  <div style="margin-top:18px; padding:12px; border:1px solid #e6edf3; background:#fbfdff; border-radius:6px;">
    <h3 style="margin-top:0; margin-bottom:8px;">Save Current Schedule</h3>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <input id="variant-name" type="text" placeholder="Schedule name (e.g. Fall 2026 plan)" style="flex:1; padding:8px; border:1px solid #d1d5db; border-radius:4px;">
      <button id="save-variant-btn" style="padding:8px 12px; background:#06b6d4; color:#fff; border-radius:6px; border:none;">Save</button>
      <div id="save-variant-msg" style="font-size:13px; color:#666; margin-left:8px;"></div>
    </div>

    <div style="margin-top:14px; border-top:1px dashed #e6eef6; padding-top:12px;">
      <h4 style="margin:0 0 8px 0;">Schedule History</h4>
      <div id="variant-history" style="display:grid; gap:10px; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr));"></div>
      <div id="variant-history-empty" style="color:#777; font-size:13px; display:none;">No saved schedules yet.</div>
    </div>
  </div>
{% endif %}

<h3>Enrolled Courses</h3>
{% if course_rows %}
<table class="course-table">
  <thead>
    <tr>
      <th>Course Code</th>
      <th>Course Name</th>
      <th>Section</th>
      <th>Professor</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for row in course_rows %}
      <tr>
        <td>{{ row.course_code }}</td>
        <td>{{ row.course_name }}</td>
        <td>{{ row.section_number }}</td>
        <td>{{ row.professor }}</td>
        <td><button class="remove-section-btn" data-section-id="{{ row.section_id }}" style="padding:4px 8px; background:#dc2626; color:#fff; border:none; border-radius:4px; cursor:pointer;">Remove</button></td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p style="color:#6b7280; font-style:italic;">No sections added to planner yet.</p>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script>
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}

const csrfToken = getCookie('csrftoken');

// Handle remove section
document.body.addEventListener('click', function(e) {
  const removeBtn = e.target.closest('.remove-section-btn');
  if (removeBtn) {
    e.preventDefault();
    const sectionId = removeBtn.dataset.sectionId;
    if (!confirm('Remove this section from planner?')) return;
    const url = '{% url "planner:remove_section" 0 %}'.replace('/0/', '/' + sectionId + '/');
    fetch(url, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {'X-CSRFToken': csrfToken}
    }).then(r => r.json()).then(j => {
      if (j.ok) {
        location.reload();
      } else {
        alert('Error: ' + (j.error || 'unknown'));
      }
    }).catch(e => alert('Network error'));
  }
});


  // Course search UI handler
  const searchInput = document.getElementById('course-search-input');
  const searchResults = document.getElementById('search-results');
  const searchStatus = document.getElementById('search-status');
  let searchTimeout;

  if (searchInput) {
    searchInput.addEventListener('input', function(e) {
      clearTimeout(searchTimeout);
      const q = e.target.value.trim();
      searchStatus.textContent = '';
      searchResults.innerHTML = '';

      if (q.length < 2) {
        searchStatus.textContent = '';
        return;
      }

      searchStatus.textContent = 'Searching...';
      searchStatus.style.color = '#666';

      searchTimeout = setTimeout(() => {
        fetch(`{% url "planner:search_sections" %}?q=${encodeURIComponent(q)}`)
          .then(r => r.json())
          .then(data => {
            searchStatus.textContent = '';
            if (!data.results || data.results.length === 0) {
              searchStatus.textContent = 'No courses found';
              searchStatus.style.color = '#999';
              searchResults.innerHTML = '';
              return;
            }
            
            searchResults.innerHTML = '';
            const userSectionIds = new Set({{ user_section_ids|safe }});
            
            data.results.forEach(section => {
              const isAlreadyAdded = userSectionIds.has(section.id);
              const card = document.createElement('div');
              card.style.cssText = `
                padding:14px; 
                border:1px solid #e5e7eb; 
                background:#fff; 
                border-radius:6px; 
                box-shadow:0 1px 3px rgba(0,0,0,0.1);
                transition:all 0.2s;
              `;
              
              card.innerHTML = `
                <div style="margin-bottom:8px;">
                  <p style="margin:0; font-weight:600; color:#1f2937; font-size:14px;">${section.code} Sec ${section.sec}</p>
                  <p style="margin:4px 0 0 0; color:#666; font-size:13px;">${section.name}</p>
                  <p style="margin:4px 0 0 0; color:#f97316; font-weight:500; font-size:12px;">${section.credit} credits</p>
                </div>
                <button class="add-course-btn" data-section-id="${section.id}" style="
                  width:100%; 
                  padding:8px; 
                  background:${isAlreadyAdded ? '#d1d5db' : '#f97316'}; 
                  color:#fff; 
                  border:none; 
                  border-radius:4px; 
                  cursor:${isAlreadyAdded ? 'not-allowed' : 'pointer'}; 
                  font-size:12px; 
                  font-weight:500;
                  opacity:${isAlreadyAdded ? '0.6' : '1'};
                  transition:all 0.2s;
                " ${isAlreadyAdded ? 'disabled' : ''}>
                  ${isAlreadyAdded ? '✓ Added' : '+ Add to Plan'}
                </button>
              `;
              searchResults.appendChild(card);
            });

            // Attach click handlers to add buttons
            document.querySelectorAll('.add-course-btn:not([disabled])').forEach(btn => {
              btn.addEventListener('click', () => addSectionToPlanner(btn.dataset.sectionId, btn.parentElement.querySelector('p').textContent));
            });
          })
          .catch(err => {
            searchStatus.textContent = 'Search error';
            searchStatus.style.color = '#d00';
          });
      }, 300); // debounce 300ms
    });
  }

  // Add section to planner (via search)
  function addSectionToPlanner(sectionId, label) {
    const searchStatus = document.getElementById('search-status');
    const fd = new FormData();
    fd.append('section_id', sectionId);

    fetch(`/planner/add/${sectionId}/`, {
      method: 'POST',
      body: fd,
      credentials: 'same-origin',
      headers: {'X-CSRFToken': csrfToken}
    }).then(r => r.json()).then(j => {
      if (j.ok) {
        searchStatus.style.color = '#0a0';
        searchStatus.textContent = 'Added successfully! Reloading...';
        setTimeout(() => location.reload(), 600);
      } else {
        searchStatus.style.color = '#d00';
        searchStatus.textContent = j.error || 'Error adding course';
      }
    }).catch(err => {
      searchStatus.style.color = '#d00';
      searchStatus.textContent = 'Network error';
    });
  }
// --- Variant (save/load/history) client logic ---
function fetchVariants(){
  fetch('{% url "planner:list_variants" %}')
    .then(r=>r.json()).then(j=>{
      const container = document.getElementById('variant-history');
      const empty = document.getElementById('variant-history-empty');
      container.innerHTML = '';
      if (!j.ok || !j.variants || j.variants.length === 0){
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      j.variants.forEach(v => {
        const card = document.createElement('div');
        card.style.cssText = 'padding:10px; border:1px solid #e6eef6; background:#fff; border-radius:6px;';
        card.innerHTML = `
          <div style="font-weight:600; margin-bottom:6px;">${v.name}</div>
          <div style="color:#666; font-size:13px; margin-bottom:8px;">Credits: ${v.credits}</div>
          <div style="display:flex; gap:8px;">
            <button class="load-variant-btn" data-variant-id="${v.id}" style="flex:1; padding:6px; background:#06b6d4; color:#fff; border-radius:4px; border:none;">Load</button>
            <button class="delete-variant-btn" data-variant-id="${v.id}" style="padding:6px; background:#ef4444; color:#fff; border-radius:4px; border:none;">Delete</button>
          </div>
        `;
        container.appendChild(card);
      });

      // bind events
      document.querySelectorAll('.load-variant-btn').forEach(btn => btn.addEventListener('click', function(){
        if (!confirm('Replace current planner with this saved schedule?')) return;
        const vid = this.dataset.variantId;
        fetch(`/planner/variant/${vid}/load/`, {method:'POST', credentials:'same-origin', headers:{'X-CSRFToken': csrfToken}})
          .then(r=>r.json()).then(j=>{ if (j.ok) location.reload(); else alert(j.error||'Error loading variant'); });
      }));

      document.querySelectorAll('.delete-variant-btn').forEach(btn => btn.addEventListener('click', function(){
        if (!confirm('Delete this saved schedule?')) return;
        const vid = this.dataset.variantId;
        fetch(`/planner/variant/${vid}/delete/`, {method:'POST', credentials:'same-origin', headers:{'X-CSRFToken': csrfToken}})
          .then(r=>r.json()).then(j=>{ if (j.ok) fetchVariants(); else alert(j.error||'Error deleting'); });
      }));
    }).catch(err=>{ console.error('Error fetching variants', err); });
}

// Save current planner as variant
const saveBtn = document.getElementById('save-variant-btn');
if (saveBtn){
  saveBtn.addEventListener('click', function(){
    const name = (document.getElementById('variant-name')||{}).value || '';
    const msg = document.getElementById('save-variant-msg');
    if (!name){ msg.style.color='#d00'; msg.textContent = 'Please enter a name.'; return; }
    msg.style.color='#666'; msg.textContent = 'Saving...';
    const fd = new FormData(); fd.append('name', name);
    fetch('{% url "planner:save_current_variant" %}', {method:'POST', body:fd, credentials:'same-origin', headers:{'X-CSRFToken': csrfToken}})
      .then(r=>r.json()).then(j=>{
        if (j.ok){ msg.style.color='#0a0'; msg.textContent = 'Saved.'; setTimeout(()=>{ msg.textContent=''; fetchVariants(); },700); }
        else { msg.style.color='#d00'; msg.textContent = j.error || 'Error saving'; }
      }).catch(err=>{ msg.style.color='#d00'; msg.textContent='Network error'; });
  });
}

// Initial load
if (document.getElementById('variant-history')) fetchVariants();
</script>
{% endblock %}
